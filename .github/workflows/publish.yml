name: Entur/Docs/Publish

on:
  workflow_call:
    inputs:
      project:
        type: string
        default: repo_name
      directory:
        type: string
        default: docs
env:
  GHA_DOCS_PUBLISH_PROJECT: ${{ inputs.project }}
  GHA_DOCS_PUBLISH_DOCS_DIRECTORY: ${{ inputs.directory }}
permissions:
  contents: read
  id-token: write
jobs:
  publish:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - id: set-project-name
        if: env.GHA_DOCS_PUBLISH_PROJECT == 'repo_name'
        shell: bash
        run: |
          echo "GHA_DOCS_PUBLISH_PROJECT=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
        # shell: bash
        # run: |
        # When time is not set, you may get this:
        # https://github.com/entur/gha-docs/actions/runs/9560523727/job/26352833012
        #
        # ERROR: (gcloud.storage.rsync)
        # There was a problem refreshing auth tokens for account
        # entur-docs-ci@entur-docs.iam.gserviceaccount.com ...
        # sudo apt install -y ntpdate
        # sudo ntpdate time.windows.com
      # - id: set-time
      - uses: actions/checkout@v4
      - id: auth
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.ENTUR_DOCS_SA }}"
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"
        with:
          version: ">= 363.0.0"
      - name: "Use gcloud CLI"
        run: "gcloud info"
      - name: Upload docs to Entur Docs GCS
        run: |
          if [[ -z "${GHA_DOCS_PUBLISH_PROJECT}" ]]; then
            echo "Project name must be specified."
            exit 1
          fi
          echo "Starting to sync files to GCS Bucket to /${GHA_DOCS_PUBLISH_PROJECT}"
          # TODO: should the target path always be .../docs ?
          gcloud storage rsync -r "${GHA_DOCS_PUBLISH_DOCS_DIRECTORY}" "gs://entur-docs.appspot.com/${GHA_DOCS_PUBLISH_PROJECT}/${GHA_DOCS_PUBLISH_DOCS_DIRECTORY}"
