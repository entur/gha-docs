name: Entur/Docs/Publish

on:
  workflow_call:
    inputs:
      project:
        type: string
        default: repo_name
      directory:
        type: string
        default: docs
env:
  GHA_DOCS_PUBLISH_PROJECT: ${{ inputs.project }}
  GHA_DOCS_PUBLISH_DOCS_DIRECTORY: ${{ inputs.directory }}
jobs:
  publish:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - id: set-project-name
        if: env.GHA_DOCS_PUBLISH_PROJECT == 'repo_name'
        shell: bash
        run: |
          echo "GHA_DOCS_PUBLISH_PROJECT=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
      - uses: actions/checkout@v4
      - uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.ENTUR_DOCS_SA }}" # Replace with the name of your GitHub Actions secret
      - uses: "google-github-actions/setup-gcloud@v2"
      - name: Upload docs to Entur Docs GCS
        run: |
          sudo apt-get install -y rsync
          rsync --version
          gsutil --version
          if [[ -z "${GHA_DOCS_PUBLISH_PROJECT}" ]]; then
            echo "Project name must be specified."
            exit 1
          fi

          echo "Preparing temp-docs directory from ${GHA_DOCS_PUBLISH_DOCS_DIRECTORY}..."
          rsync -R -r ${GHA_DOCS_PUBLISH_DOCS_DIRECTORY}/** temp-docs -v

          echo "Starting to sync files to GCS Bucket to /${GHA_DOCS_PUBLISH_PROJECT}"
          gsutil -m rsync -d -r temp-docs/* "gs://staging.entur-docs.appspot.com/${GHA_DOCS_PUBLISH_PROJECT}/${GHA_DOCS_PUBLISH_DOCS_DIRECTORY}"

          echo "Removing temp-docs directory..."
          rm -rfv temp-docs
